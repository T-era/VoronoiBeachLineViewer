<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
<style type="text/css">
html, body {
	margin: 0px;
	padding: 0px;
	width: 100%;
	height: 100%;
}
div.border {
	border: 1px #aaf solid;
}
canvas {
	float: left;
	width: 80%;
	height: 80%;
}
textarea {
	width: 100%;
}
input {
	display: block;
}
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript">
Voronoi = {};

$(function() {
	var cnv = $("#canvas");
	var canvas = cnv[0];
	Voronoi.WorldSize = canvas;
	// 表示上のサイズに合わせて、描画領域のサイズを設定。(円が丸っこく見えるように)
	canvas.height = canvas.width * canvas.offsetHeight / canvas.offsetWidth;

	var isInitMode = false;
	var seed = [];
	var beachLine;

	var context = canvas.getContext("2d");
	context.clearAll = function() {
		this.clearRect(0,0,canvas.width, canvas.height);
	};
	setCommonEvents();
	initMode();
	var beachLine;

	function setCommonEvents() {
		cnv.mousemove(
			function(e) {
				var l = oToL(e, e.target);
				var str = showPoint(l);
				$("#showPosition").val(str);
			});
		$("#eventButton").click(function() {
			beachLine.stepNextEvent();
			beachLine.draw(context);
		});
		$("#pixelButton").click(function() {
			beachLine.stepPixel();
			beachLine.draw(context);
		});
		$("#runButton").click(runAll);
		$("#runButton1").click(skipAll);
		$("#putRandom").click(function() {
			for (var i = 0; i < 10; i ++) {
				seed.push({
					x: Math.random() * canvas.width,
					y: Math.random() * canvas.height
				});
			}
			drawSeed();
		});
		$("#clearPoints").click(function() {
			seed.length = 0;
			context.clearAll();
		});
		$("#backToInit").click(initMode);
		$("#done").click(stepMode);
		$("#giraffeMode").click(setGiraffeMode);
		cnv.click(function(arg) {
			if (isInitMode) {
				var target = arg.target;
				var l = oToL(arg, target);
				seed.push(l);
				drawSeed();
			}
		});

		function drawSeed() {
			seed.forEach(function(p) {
				context.beginPath();
				context.strokeStyle = "#000";
				context.arc(p.x, p.y, 2, 0, 7);
				context.stroke();
			});
		}
		function runAll() {
			var done = beachLine.stepNextEvent();
			beachLine.draw(context);
			
			if (!done) {
				setTimeout(runAll, 1);
			}
		}
		function skipAll() {
			do {
			} while (!beachLine.stepNextEvent());
			beachLine.draw(context);
		}
		function setGiraffeMode(event) {
			var flg = event.target.checked;
			if (!flg) alert("マジで...!?");
			cnv.css({background: flg ? "#a80" : "#fff" });
			Voronoi.BeachLine.isGiraffeMode = flg;
			Voronoi.MPoint.isGiraffeMode = flg;
		}
	}

	function initMode() {
		isInitMode = true;
		logClear();
		
		$("#Initializer").show();
		$("#BeachLineControl").hide();
	}

	function stepMode() {
		isInitMode = false;
		$("#Initializer").hide();
		$("#BeachLineControl").show();

		beachLine = new Voronoi.BeachLine(seed, logAppend);
	}

	function logAppend(str) {
		$("#logView").val($("#logView").val() + str + "\n");
	}
	function logClear() {
		$("#logView").val("");
	}
	function oToL(p, target) {
		return {
			x: (p.clientX - target.getBoundingClientRect().left)
				* target.width / target.offsetWidth,
			y: (p.clientY - target.getBoundingClientRect().top)
				* target.height / target.offsetHeight
		};
	}
});
</script>
<script type="text/javascript" src="JunkRack.js"></script>
<script type="text/javascript" src="Circle.js"></script>
<script type="text/javascript" src="Curv.js"></script>
<script type="text/javascript" src="BeachLine.js"></script>
<script type="text/javascript" src="BeachLineNode.js"></script>
<script type="text/javascript" src="Event.js"></script>
<script type="text/javascript" src="MotherPoint.js"></script>
<script type="text/javascript" src="Line.js"></script>
	</head>
	<body>
		<canvas id="canvas" width="1000">HTML5 Canvas required!</canvas>
		<div style="float: left;">
			<input type="text" value="" id="showPosition" readonly />
			<div class="border" id="BeachLineControl">
				<input type="button" value="Next EVENT" id="eventButton" />
				<input type="button" value="Next PIXEL" id="pixelButton" />
				<input type="button" value="Run Through" id="runButton" />
				<input type="button" value="(no animation)" id="runButton1" />
				<hr/>
				<input type="button" value="母点の配置を変える" id="backToInit" />
				<hr/>
				<input type="checkbox" id="giraffeMode" style="display: inline;" />きりんがすき。
			</div>
			<div class="border" id="Initializer">
				<input type="button" value="ランダムに配置する" id="putRandom" />
				<input type="button" value="まっさらに戻す" id="clearPoints" />
				<input type="button" value="この配置でGO" id="done" />
			</div>
		</div>
		<textarea id="logView" readonly ></textarea>
	</body>
</html>